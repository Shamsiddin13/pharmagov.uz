import{g as u,h as U,q as z,c as x,a as e,d as m,w as E,z as L,i as c,j as O,F as Q,b as Z,t as b,v as _,B as M,H,o as w,k as J,m as X}from"./index-D3wbM7oO.js";import{u as G}from"./useStorageFilterData-CC75njG6.js";import{A as D,l as W}from"./storageOperations-BR2fpJKr.js";import{_ as S}from"./SearchSelect-tzwJ1XQW.js";import{f as i,u as $}from"./numberFormat-CYHKIeaX.js";import"./auth-Buz3Qiex.js";const Y={class:"space-y-6"},tt={class:"bg-white dark:bg-gray-800 shadow rounded-lg p-6"},et={class:"flex justify-between items-center"},at={class:"bg-white dark:bg-gray-800 shadow rounded-lg p-6"},rt={class:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4"},ot={class:"space-y-4"},st={class:"flex justify-between"},lt={class:"text-sm font-medium text-gray-700 dark:text-gray-300"},dt=["onClick"],nt=["onClick"],it={class:"space-y-4"},ut={class:"flex gap-4"},ct={class:"flex-grow"},gt={class:"w-48"},bt=["onUpdate:modelValue"],_t={class:"flex gap-4"},yt={class:"flex-1"},pt={class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},mt=["onUpdate:modelValue","onInput","disabled"],vt={class:"flex-1"},kt=["onUpdate:modelValue","onInput","disabled"],ft={class:"flex-1"},ht={class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},xt=["onUpdate:modelValue","onInput","disabled"],wt={class:"space-y-4 pt-6 border-t border-gray-200 dark:border-gray-700"},St={class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},It=["value"],Vt={class:"flex justify-end space-x-4"},qt=["disabled"],Nt={__name:"LossStorageView",setup(Ut){const B=X();G();const y=u(!1),a=u({store_id:"",kontragent_id:"",k_amount:0,formatted_k_amount:"0",k_debt_currency:"",type:"loss",description:"",items:[]}),I=u(null),g=u(null),v=u([]),V={1:{id:1},5:{id:5},17:{id:35},18:{id:34},24:{id:110}},p=()=>{a.value.items.push({product_id:"",base_product_id:"",product_name:"",sku:"",article:"",real_buy_price:0,quantity:1,sub_total:0,formatted_sub_total:"0"})},C=r=>{a.value.items.splice(r,1),a.value.items.length===0&&p(),f()},P=async r=>{if(r){if(I.value=r,a.value.store_id=r.id,a.value.kontragent_id=null,g.value=null,V[r.id]){try{const t=localStorage.getItem("token"),s=await M.get(`${D}/search/kontragents`,{params:{id:V[r.id].id},headers:{Authorization:`Bearer ${t}`}});if(s.data&&s.data[0]){const d=s.data[0];a.value.kontragent_id=d.id,g.value=d}}catch(t){console.error("Error fetching mapped kontragent:",t)}return}if(r.group_id===48)try{const t=localStorage.getItem("token"),s=await M.get(`${D}/search/kontragents`,{params:{store_id:r.id,limit:1},headers:{Authorization:`Bearer ${t}`}});if(s.data&&s.data[0]){const d=s.data[0];a.value.kontragent_id=d.id,g.value=d}}catch(t){console.error("Error fetching kontragent:",t)}}},N=r=>{g.value=r,a.value.kontragent_id=r.id},F=(r,t)=>{const s=r.id,d=r.type==="variant"?r.base_product_id:r.id;if(a.value.items.some((n,l)=>l!==t&&n.product_id===s)){alert("Bu mahsulot qo'shilgan"),a.value.items[t].product_id="",a.value.items[t].product_name="",a.value.items[t].sku="",v.value[t]&&v.value[t].reset();return}const o=a.value.items[t];o.product_id=s,o.base_product_id=d,o.product_name=r.name,o.sku=r.sku,o.real_buy_price=Math.round(r.buy_price),o.formatted_buy_price=i(o.real_buy_price),o.article=r.article,k(t)},K=(r,t)=>{const s=a.value.items[t],d=$(r.target.value);s.real_buy_price=d,s.formatted_buy_price=i(d),k(t)},j=r=>{k(r)},A=(r,t)=>{const s=a.value.items[t],d=$(r.target.value);s.sub_total=d,s.formatted_sub_total=i(d),s.sub_total&&s.quantity&&(s.real_buy_price=Math.round(s.sub_total/parseInt(s.quantity)),s.formatted_buy_price=i(s.real_buy_price)),f()},k=r=>{const t=a.value.items[r];t.real_buy_price&&t.quantity&&(t.sub_total=Math.round(t.real_buy_price*parseInt(t.quantity)),t.formatted_sub_total=i(t.sub_total),f())},f=()=>{a.value.k_amount=a.value.items.reduce((r,t)=>r+(t.sub_total?parseInt(t.sub_total):0),0)};U(()=>a.value.k_amount,r=>{a.value.formatted_k_amount=i(r)});const q=u(a.value.formatted_k_amount);U(()=>a.value.k_amount,r=>{q.value=i(r)});const T=()=>{if(!a.value.store_id)return alert("Please select a store"),!1;if(!a.value.k_debt_currency)return alert("Please select a currency"),!1;if(!a.value.kontragent_id)return alert("Please select a kontragent"),!1;if(!a.value.items.length)return alert("Please add at least one item"),!1;for(const r of a.value.items)if(!r.product_id||!r.real_buy_price||!r.quantity)return alert("Please fill all required fields for each item"),!1;return!0},R=async()=>{if(T())try{y.value=!0;const r={store_id:parseInt(a.value.store_id),kontragent_id:parseInt(a.value.kontragent_id),k_amount:parseInt(a.value.k_amount),k_debt_currency:a.value.k_debt_currency,description:a.value.description||"",items:a.value.items.map(t=>({product_id:parseInt(t.base_product_id||t.product_id),sku:t.sku||"",article:t.article||"",real_buy_price:parseInt(t.real_buy_price),quantity:parseInt(t.quantity),sub_total:parseInt(t.sub_total)}))};await W(r),B.push("/storage")}catch(r){console.error("Failed to save loss storage:",r),alert(r.message||"Failed to save")}finally{y.value=!1}};return z(()=>{p()}),(r,t)=>{var d,h;const s=H("router-link");return w(),x("div",Y,[e("div",tt,[e("div",et,[t[6]||(t[6]=e("h1",{class:"text-2xl font-semibold text-gray-900 dark:text-white"},"Ombordan chiqarib yuborish",-1)),m(s,{to:"/storage",class:"px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"},{default:E(()=>t[5]||(t[5]=[J(" Omborga qaytish ")])),_:1})])]),e("div",at,[e("form",{onSubmit:L(R,["prevent"]),class:"space-y-6"},[e("div",rt,[e("div",null,[t[7]||(t[7]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Do'kon",-1)),m(S,{modelValue:a.value.store_id,"onUpdate:modelValue":t[0]||(t[0]=o=>a.value.store_id=o),"display-value":((d=I.value)==null?void 0:d.name)||"",placeholder:"Do'konni tanlash...","search-endpoint":"/search/stores",onSelect:P},null,8,["modelValue","display-value"])]),e("div",null,[t[8]||(t[8]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Kontragent",-1)),m(S,{modelValue:a.value.kontragent_id,"onUpdate:modelValue":t[1]||(t[1]=o=>a.value.kontragent_id=o),"display-value":((h=g.value)==null?void 0:h.name)||"",placeholder:"Kontragentni tanlash...","search-endpoint":"/search/kontragents","additional-params":{store_id:a.value.store_id},onSelect:N,disabled:!a.value.store_id},null,8,["modelValue","display-value","additional-params","disabled"])]),e("div",null,[t[10]||(t[10]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Valyuta",-1)),c(e("select",{"onUpdate:modelValue":t[2]||(t[2]=o=>a.value.k_debt_currency=o),class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-indigo-500"},t[9]||(t[9]=[e("option",{value:""},"Valyutani tanlash",-1),e("option",{value:"UZS"},"UZS",-1),e("option",{value:"USD"},"USD",-1)]),512),[[O,a.value.k_debt_currency]])])]),e("div",ot,[e("div",{class:"flex justify-between items-center"},[t[11]||(t[11]=e("h2",{class:"text-lg font-medium text-gray-900 dark:text-white"},"Mahsulotlar",-1)),e("button",{type:"button",onClick:p,class:"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"}," Mahsulot qo'shish ")]),(w(!0),x(Q,null,Z(a.value.items,(o,n)=>(w(),x("div",{key:n,class:"p-4 border border-gray-200 dark:border-gray-700 rounded-lg space-y-4"},[e("div",st,[e("h3",lt,"Mahsulot "+b(n+1),1),e("button",{type:"button",onClick:l=>p(),class:"text-blue-600 hover:text-blue-700"}," Mahsulot qo'shish ",8,dt),e("button",{type:"button",onClick:l=>C(n),class:"text-red-600 hover:text-red-700"}," Mahsulotni o'chirish ",8,nt)]),e("div",it,[e("div",ut,[e("div",ct,[t[12]||(t[12]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Mahsulot",-1)),m(S,{ref_for:!0,ref_key:"searchRefs",ref:v,"model-value":o.product_name,"display-value":o.product_name,"search-endpoint":"/search/products","additional-params":{store_id:a.value.store_id},placeholder:"Mahsulotni tanlash...",disabled:!a.value.store_id,onSelect:l=>F(l,n)},null,8,["model-value","display-value","additional-params","disabled","onSelect"])]),e("div",gt,[t[13]||(t[13]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"SKU",-1)),c(e("input",{type:"text","onUpdate:modelValue":l=>o.sku=l,readonly:"",class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-600 text-gray-900 dark:text-white px-4 py-2"},null,8,bt),[[_,o.sku]])])]),e("div",_t,[e("div",yt,[e("label",pt,"Xarid Narxi ("+b(a.value.k_debt_currency||"-")+")",1),c(e("input",{type:"text","onUpdate:modelValue":l=>o.formatted_buy_price=l,onInput:l=>K(l,n),disabled:!o.product_id,class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-indigo-500 disabled:bg-gray-100 dark:disabled:bg-gray-800 disabled:cursor-not-allowed"},null,40,mt),[[_,o.formatted_buy_price]])]),e("div",vt,[t[14]||(t[14]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Miqdori",-1)),c(e("input",{type:"number","onUpdate:modelValue":l=>o.quantity=l,onInput:l=>j(n),disabled:!o.product_id,required:"",min:"1",class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-indigo-500 disabled:bg-gray-100 dark:disabled:bg-gray-800 disabled:cursor-not-allowed"},null,40,kt),[[_,o.quantity]])]),e("div",ft,[e("label",ht,"Jami Narxi ("+b(a.value.k_debt_currency||"-")+")",1),c(e("input",{type:"text","onUpdate:modelValue":l=>o.formatted_sub_total=l,onInput:l=>A(l,n),disabled:!o.product_id,class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-indigo-500 disabled:bg-gray-100 dark:disabled:bg-gray-800 disabled:cursor-not-allowed"},null,40,xt),[[_,o.formatted_sub_total]])])])])]))),128))]),e("div",wt,[e("div",null,[e("label",St,"Umumiy summa ("+b(a.value.k_debt_currency||"-")+")",1),e("input",{type:"text",value:q.value,readonly:"",class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-600 text-gray-900 dark:text-white px-4 py-2"},null,8,It)]),e("div",null,[t[15]||(t[15]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Qoshimcha ma'lumot",-1)),c(e("textarea",{"onUpdate:modelValue":t[3]||(t[3]=o=>a.value.description=o),rows:"3",class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-indigo-500"},null,512),[[_,a.value.description]])])]),e("div",Vt,[e("button",{type:"button",onClick:t[4]||(t[4]=o=>r.$router.push("/storage")),class:"px-6 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"}," Bekor qilish "),e("button",{type:"submit",disabled:y.value,class:"px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50"},b(y.value?"Saqlanmoqda...":"Saqlash"),9,qt)])],32)])])}}};export{Nt as default};
