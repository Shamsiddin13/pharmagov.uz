import{g,p as f,q as G,c as l,a as t,t as h,d as k,w as C,u as Q,z as W,i as c,j as X,F as E,b as N,v as y,f as x,B as $,K as S,E as H,o as n,k as D,m as J,l as ee,G as te}from"./index-D3wbM7oO.js";import{_ as F}from"./Button-1RoVZDeX.js";import{_ as T}from"./ApiSearchSelect-CmtQZZ6U.js";import"./SearchSelect-tzwJ1XQW.js";const re={class:"space-y-6"},ae={class:"bg-white dark:bg-gray-800 shadow rounded-lg p-6"},oe={class:"flex justify-between items-center"},se={class:"text-2xl font-semibold text-gray-900 dark:text-white"},de={class:"bg-white dark:bg-gray-800 shadow rounded-lg p-6"},ie={class:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"},le={class:"relative"},ne=["value"],ue={key:0,class:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"},ce={key:0},me={class:"relative"},pe={key:1},ge={class:"relative"},ye={class:"space-y-4"},ve={class:"flex justify-between items-start"},_e={class:"text-md font-medium text-gray-900 dark:text-white"},be=["onClick"],fe={class:"grid grid-cols-12 gap-4"},he={class:"col-span-9"},ke={class:"col-span-3"},xe=["onUpdate:modelValue"],we={class:"grid grid-cols-1 md:grid-cols-3 gap-4"},Ie=["onUpdate:modelValue"],Se=["value","onInput"],qe=["value","onInput"],Ue={class:"space-y-4 pt-6 border-t border-gray-200 dark:border-gray-700"},Ve={class:"flex justify-end pt-4"},Ne={__name:"CreateShipment",setup(Me){const q=J(),w=ee(),u=g(!1),m=f(()=>!!w.params.id),j=f(()=>m.value?"Yukni Tahrirlash":"Yukni Yaratish"),v=g(null),U=g([]),I=g(null),V=[{id:"zoodmall",name:"ZoodMall"},{id:"wildberries",name:"Wildberries"},{id:"fbs",name:"FBS"},{id:"fba",name:"FBA"},{id:"ofis",name:"Ofis"}],r=g({store_id:null,order_method:"",order_id:"",invoice_id:"",items:[],description:""}),M=f(()=>["zoodmall","fbs","wildberries"].includes(r.value.order_method)),z=f(()=>["fbs","fba"].includes(r.value.order_method)),L=s=>{v.value=s,r.value.store_id=s.id,r.value.items.forEach((e,o)=>{const a=U.value[o];a&&typeof a.reset=="function"&&a.reset()}),r.value.items.forEach((e,o)=>{r.value.items[o]={...r.value.items[o],product_id:null,variant_id:null,product_name:"",sku:"",article:"",quantity:1,formatted_buy_price:"0",formatted_sell_price:"0"}})},B=()=>{r.value.items.push({product_id:null,variant_id:null,product_name:"",sku:"",article:"",quantity:1,formatted_buy_price:"0",formatted_sell_price:"0"})},P=s=>{r.value.items.splice(s,1)},R=(s,e)=>{const o=r.value.items.findIndex((a,d)=>d!==e&&a.product_id===s.id);if(o!==-1){alert(`This product already exists in item ${o+1}`);return}r.value.items[e]={...r.value.items[e],product_id:s.id,variant_id:s.variant_id,product_name:s.name,sku:s.sku,article:s.article,formatted_buy_price:p(s.buy_price||0),formatted_sell_price:"0"}},Y=async()=>{if(m.value)try{u.value=!0;const s=localStorage.getItem("token");if(!s)throw new Error("No token found");const e=await $.get(`${S}/shipments/send/${w.params.id}`,{headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}});if(!e.data.success)throw new Error(e.data.message||"Failed to load shipment");const o=e.data.data;console.log("Loaded shipment:",o),console.log("Original order method:",o.order_method);const a=V.find(d=>{var i,b;return d.id.toLowerCase()===((i=o.order_method)==null?void 0:i.toLowerCase())||d.name.toLowerCase()===((b=o.order_method)==null?void 0:b.toLowerCase())});r.value={store_id:o.store_id,order_method:(a==null?void 0:a.id)||"",order_id:o.order_id||"",invoice_id:o.invoice_id||"",description:o.desc||"",items:[{product_id:o.product_id,variant_id:o.variant_id,product_name:o.product,sku:o.sku,article:o.article,quantity:o.quantity,formatted_buy_price:p(o.buy_price||0),formatted_sell_price:p(o.sell_price||0),uzum_sku:o.uzum_sku||""}]},v.value={id:o.store_id,name:o.store},console.log("Matched order method:",a),console.log("Form data:",r.value)}catch(s){console.error("Error loading shipment:",s)}finally{u.value=!1}},A=async()=>{var s;try{if(u.value=!0,!te.token)throw new Error("Not authenticated");const e=localStorage.getItem("token");if(!e)throw new Error("No token found");if(!((s=I.value)!=null&&s.id))throw new Error("User data not loaded");const o=r.value.items.map(async a=>{const d={store_id:r.value.store_id,user_id:I.value.id,store:v.value.name,product:a.product_name,article:a.article,sku:a.sku,quantity:parseInt(a.quantity),buy_price:parseFloat(_(a.formatted_buy_price)),sell_price:parseFloat(_(a.formatted_sell_price)),order_method:r.value.order_method,desc:r.value.description||null};r.value.order_method==="zoodmall"||r.value.order_method==="wildberries"?d.order_id=r.value.order_id:r.value.order_method==="fbs"?(d.order_id=r.value.order_id,d.invoice_id=r.value.invoice_id):r.value.order_method==="fba"&&(d.invoice_id=r.value.invoice_id),a.uzum_sku&&(d.uzum_sku=a.uzum_sku);const i=m.value?`${S}/shipments/send/${w.params.id}`:`${S}/shipments/send/create`,b=m.value?"put":"post";return $({method:b,url:i,data:d,headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}})});await Promise.all(o),q.push("/shipment")}catch(e){console.error("Error saving shipment:",e)}finally{u.value=!1}},O=(s,e)=>{const o=r.value.items[e];o.formatted_buy_price=p(_(s.target.value))},K=(s,e)=>{const o=r.value.items[e];o.formatted_sell_price=p(_(s.target.value))},p=s=>new Intl.NumberFormat("uz-UZ").format(s),_=s=>parseInt(s.replace(/\D/g,""))||0,Z=async()=>{try{const s=await H();I.value=s}catch(s){console.error("Error loading user data:",s)}};return G(()=>{Z(),m.value?Y():B()}),(s,e)=>{var o;return n(),l("div",re,[t("div",ae,[t("div",oe,[t("h1",se,h(j.value),1),k(F,{variant:"secondary",onClick:e[0]||(e[0]=a=>Q(q).back())},{default:C(()=>e[6]||(e[6]=[D(" Qaytish ")])),_:1})])]),t("div",de,[t("form",{onSubmit:W(A,["prevent"]),class:"space-y-6"},[t("div",ie,[t("div",null,[e[7]||(e[7]=t("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Do'kon",-1)),k(T,{modelValue:r.value.store_id,"onUpdate:modelValue":e[1]||(e[1]=a=>r.value.store_id=a),"display-value":((o=v.value)==null?void 0:o.name)||"",placeholder:"Search store...",endpoint:"/search/stores",onSelect:L},null,8,["modelValue","display-value"])]),t("div",null,[e[9]||(e[9]=t("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Buyurtma Turi",-1)),t("div",le,[c(t("select",{"onUpdate:modelValue":e[2]||(e[2]=a=>r.value.order_method=a),class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-indigo-500",required:""},[e[8]||(e[8]=t("option",{value:"",disabled:""},"Buyurtma turini tanlang",-1)),(n(),l(E,null,N(V,a=>t("option",{key:a.id,value:a.id},h(a.name),9,ne)),64))],512),[[X,r.value.order_method]])])])]),M.value||z.value?(n(),l("div",ue,[M.value?(n(),l("div",ce,[e[10]||(e[10]=t("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Buyurtma ID",-1)),t("div",me,[c(t("input",{type:"text","onUpdate:modelValue":e[3]||(e[3]=a=>r.value.order_id=a),class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-indigo-500",placeholder:"Buyurtma raqami",required:""},null,512),[[y,r.value.order_id]])])])):x("",!0),z.value?(n(),l("div",pe,[e[11]||(e[11]=t("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Nakladnoy raqami",-1)),t("div",ge,[c(t("input",{type:"text","onUpdate:modelValue":e[4]||(e[4]=a=>r.value.invoice_id=a),class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-indigo-500",placeholder:"Nakladnoy raqami",required:""},null,512),[[y,r.value.invoice_id]])])])):x("",!0)])):x("",!0),t("div",ye,[t("div",{class:"flex justify-between items-center"},[e[12]||(e[12]=t("h2",{class:"text-lg font-medium text-gray-900 dark:text-white"},"Mahsulotlar",-1)),t("button",{type:"button",onClick:B,class:"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"}," Mahsulot qo'shish ")]),(n(!0),l(E,null,N(r.value.items,(a,d)=>(n(),l("div",{key:d,class:"p-4 border border-gray-200 dark:border-gray-700 rounded-lg space-y-4"},[t("div",ve,[t("h3",_e,"Mahsulot "+h(d+1),1),r.value.items.length>1?(n(),l("button",{key:0,type:"button",onClick:i=>P(d),class:"text-red-600 hover:text-red-700"}," Mahsulotni o'chirish ",8,be)):x("",!0)]),t("div",fe,[t("div",he,[e[13]||(e[13]=t("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Mahsulot",-1)),k(T,{ref_for:!0,ref:i=>{i&&(U.value[d]=i)},"model-value":a.product_id,"display-value":a.product_name,endpoint:"/search/products","additional-params":{store_id:r.value.store_id},placeholder:"Mahsulotni qidirish",disabled:!r.value.store_id,onSelect:i=>R(i,d)},null,8,["model-value","display-value","additional-params","disabled","onSelect"])]),t("div",ke,[e[14]||(e[14]=t("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"SKU",-1)),c(t("input",{type:"text","onUpdate:modelValue":i=>a.sku=i,class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2",readonly:""},null,8,xe),[[y,a.sku]])])]),t("div",we,[t("div",null,[e[15]||(e[15]=t("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Miqdor",-1)),c(t("input",{type:"number","onUpdate:modelValue":i=>a.quantity=i,min:"1",class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-indigo-500"},null,8,Ie),[[y,a.quantity]])]),t("div",null,[e[16]||(e[16]=t("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Xarid narxi",-1)),t("input",{type:"text",value:a.formatted_buy_price,onInput:i=>O(i,d),class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-indigo-500"},null,40,Se)]),t("div",null,[e[17]||(e[17]=t("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Sotuv narxi",-1)),t("input",{type:"text",value:a.formatted_sell_price,onInput:i=>K(i,d),class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-indigo-500"},null,40,qe)])])]))),128))]),t("div",Ue,[t("div",null,[e[18]||(e[18]=t("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Izoh",-1)),c(t("input",{type:"text","onUpdate:modelValue":e[5]||(e[5]=a=>r.value.description=a),class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-indigo-500"},null,512),[[y,r.value.description]])])]),t("div",Ve,[k(F,{type:"submit",variant:"primary",disabled:u.value,class:"px-6"},{default:C(()=>[D(h(u.value?"Yaratilyapti...":"Yaratish"),1)]),_:1},8,["disabled"])])],32)])])}}};export{Ne as default};
