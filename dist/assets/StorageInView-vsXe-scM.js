import{A as K,g,h as z,q as E,c as S,a as e,d as f,w as R,z as L,F as Q,b as Z,i as m,v as p,t as U,H,o as I,k as J,m as O,B as X}from"./index-D3wbM7oO.js";import{_ as V}from"./SearchSelect-tzwJ1XQW.js";const G={class:"space-y-6"},W={class:"bg-white dark:bg-gray-800 shadow rounded-lg p-6"},Y={class:"flex justify-between items-center"},tt={class:"bg-white dark:bg-gray-800 shadow rounded-lg p-6"},et={class:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"},at={class:"space-y-4"},rt={class:"flex justify-between"},ot={class:"text-sm font-medium text-gray-700 dark:text-gray-300"},st=["onClick"],lt={class:"space-y-4"},dt={class:"flex gap-4"},nt={class:"flex-grow"},ut={class:"w-48"},it=["onUpdate:modelValue"],ct={class:"flex gap-4"},mt={class:"flex-1"},pt=["onUpdate:modelValue","onInput"],gt={class:"flex-1"},_t=["onUpdate:modelValue","onInput"],yt={class:"flex-1"},bt=["onUpdate:modelValue","onInput"],vt={class:"space-y-4 pt-6 border-t border-gray-200 dark:border-gray-700"},ft={class:"flex justify-end"},kt=["disabled"],M="https://api.mgoods.uz/api",St={__name:"StorageInView",setup(ht){const c=K(),B=O(),_=g(!1),k=g(null),y=g(null),h=g([]),a=g({store_id:"",kontragent_id:"",k_amount:0,formatted_k_amount:"0",k_debt_currency:"UZS",type:"in",description:"",items:[]}),x=()=>{a.value.items.push({product_id:"",base_product_id:"",product_name:"",sku:"",article:"",real_buy_price:0,formatted_buy_price:"0",quantity:1,sub_total:0,formatted_sub_total:"0"})},D=r=>{a.value.items.splice(r,1),a.value.items.length===0&&x(),b()},F=async r=>{if(k.value=r,a.value.store_id=r.id,y.value=null,a.value.kontragent_id="",a.value.items.forEach(t=>{t.product_id="",t.product_name="",t.sku="",t.article="",t.real_buy_price=0,t.formatted_buy_price="0",t.quantity=1,t.sub_total=0,t.formatted_sub_total="0"}),r.group_id===48)try{const t=await fetch(`${M}/search/kontragents?store_id=${r.id}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`,"Content-Type":"application/json"}});if(!t.ok)throw new Error("Failed to fetch kontragent");const[o]=await t.json();o&&(y.value=o,a.value.kontragent_id=o.id)}catch(t){console.error("Error fetching kontragent:",t)}b()},P=r=>{y.value=r,a.value.kontragent_id=r.id},i=r=>new Intl.NumberFormat("uz-UZ").format(r),q=r=>parseFloat(r.replace(/[^0-9.-]+/g,""))||0,j=(r,t)=>{const o=q(r.target.value);a.value.items[t].real_buy_price=o,a.value.items[t].formatted_buy_price=i(o),w(t)},C=r=>{w(r)},N=(r,t)=>{const o=q(r.target.value),d=a.value.items[t];d.sub_total=o,d.quantity>0&&(d.real_buy_price=o/d.quantity,d.formatted_buy_price=i(d.real_buy_price)),d.formatted_sub_total=i(o),b()},w=r=>{const t=a.value.items[r];t.sub_total=t.real_buy_price*t.quantity,t.formatted_sub_total=i(t.sub_total),t.formatted_buy_price=i(t.real_buy_price),b()},T=(r,t)=>{const o=r.id,d=r.type==="variant"?r.base_product_id:r.id;if(a.value.items.some((s,u)=>u!==t&&s.product_id===o)){alert("Bu mahsulot qo'shilgan"),a.value.items[t].product_id="",a.value.items[t].product_name="",a.value.items[t].sku="",h.value[t]&&h.value[t].reset();return}const l=a.value.items[t];l.product_id=o,l.base_product_id=d,l.product_name=r.name,l.sku=r.sku,l.real_buy_price=Math.round(r.buy_price),l.formatted_buy_price=i(l.real_buy_price),l.article=r.article,w(t)},$=()=>{if(!a.value.store_id)return c.error("Please select a store"),!1;if(!a.value.kontragent_id)return c.error("Please select a kontragent"),!1;if(!a.value.items.length)return c.error("Please add at least one item"),!1;for(const r of a.value.items)if(!r.product_id)return c.error("Please select a product for all items"),!1;return!0},A=async()=>{var r,t;if($())try{_.value=!0;const o=localStorage.getItem("token"),d={...a.value,k_amount:a.value.k_amount,items:a.value.items.map(l=>({product_id:parseInt(l.base_product_id||l.product_id),sku:l.sku||"",article:l.article||"",real_buy_price:parseInt(l.real_buy_price),quantity:parseInt(l.quantity),sub_total:parseInt(l.sub_total)}))};(await X.post(`${M}/storages/store/in`,d,{headers:{Authorization:`Bearer ${o}`,Accept:"application/json"}})).data.status&&(c.success("Storage entry created successfully"),B.push("/storage"))}catch(o){console.error("Error creating storage entry:",o),c.error(((t=(r=o.response)==null?void 0:r.data)==null?void 0:t.message)||"Failed to create storage entry")}finally{_.value=!1}};z(()=>a.value.k_amount,r=>{a.value.formatted_k_amount=i(r)});const b=()=>{const r=a.value.items.reduce((t,o)=>t+o.sub_total,0);a.value.k_amount=r,a.value.formatted_k_amount=i(r)};return E(()=>{x()}),(r,t)=>{var d,v,l;const o=H("router-link");return I(),S("div",G,[e("div",W,[e("div",Y,[t[5]||(t[5]=e("h1",{class:"text-2xl font-semibold text-gray-900 dark:text-white"},"Kirim",-1)),f(o,{to:"/storage",class:"px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"},{default:R(()=>t[4]||(t[4]=[J(" Omborga qaytish ")])),_:1})])]),e("div",tt,[e("form",{onSubmit:L(A,["prevent"]),class:"space-y-6"},[e("div",et,[e("div",null,[t[6]||(t[6]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Do'kon",-1)),f(V,{modelValue:a.value.store_id,"onUpdate:modelValue":t[0]||(t[0]=s=>a.value.store_id=s),"display-value":((d=k.value)==null?void 0:d.name)||"",placeholder:"Do'konni tanlash...","search-endpoint":"/search/stores","additional-params":{group_id:48},onSelect:F},null,8,["modelValue","display-value"])]),e("div",null,[t[7]||(t[7]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Kontragent",-1)),f(V,{modelValue:a.value.kontragent_id,"onUpdate:modelValue":t[1]||(t[1]=s=>a.value.kontragent_id=s),"display-value":((v=y.value)==null?void 0:v.name)||"",placeholder:"Kontragentni qidirish...","search-endpoint":"/search/kontragents","additional-params":{store_id:a.value.store_id},onSelect:P,disabled:((l=k.value)==null?void 0:l.group_id)===48},null,8,["modelValue","display-value","additional-params","disabled"])])]),e("div",at,[e("div",{class:"flex justify-between items-center"},[t[8]||(t[8]=e("h2",{class:"text-lg font-medium text-gray-900 dark:text-white"},"Mahsulotlar",-1)),e("button",{type:"button",onClick:x,class:"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"}," Mahsulot qo'shish ")]),(I(!0),S(Q,null,Z(a.value.items,(s,u)=>(I(),S("div",{key:u,class:"p-4 border border-gray-200 dark:border-gray-700 rounded-lg space-y-4"},[e("div",rt,[e("h3",ot,"Mahsulot "+U(u+1),1),e("button",{type:"button",onClick:n=>D(u),class:"text-red-600 hover:text-red-700"}," Mahsulotni o'chirish ",8,st)]),e("div",lt,[e("div",dt,[e("div",nt,[t[9]||(t[9]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Mahsulot",-1)),f(V,{ref_for:!0,ref_key:"searchRefs",ref:h,"model-value":s.product_name,"display-value":s.product_name,"search-endpoint":"/search/products","additional-params":{store_id:a.value.store_id},placeholder:"Mahsulotni qidirish...",disabled:!a.value.store_id,onSelect:n=>T(n,u)},null,8,["model-value","display-value","additional-params","disabled","onSelect"])]),e("div",ut,[t[10]||(t[10]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"SKU",-1)),m(e("input",{type:"text","onUpdate:modelValue":n=>s.sku=n,readonly:"",class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-600 text-gray-900 dark:text-white px-4 py-2"},null,8,it),[[p,s.sku]])])]),e("div",ct,[e("div",mt,[t[11]||(t[11]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Xarid Narxi",-1)),m(e("input",{type:"text","onUpdate:modelValue":n=>s.formatted_buy_price=n,onInput:n=>j(n,u),class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-white px-4 py-2"},null,40,pt),[[p,s.formatted_buy_price]])]),e("div",gt,[t[12]||(t[12]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Miqdor",-1)),m(e("input",{type:"number","onUpdate:modelValue":n=>s.quantity=n,min:"1",onInput:()=>C(u),class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-white px-4 py-2"},null,40,_t),[[p,s.quantity]])]),e("div",yt,[t[13]||(t[13]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Jami summa",-1)),m(e("input",{type:"text","onUpdate:modelValue":n=>s.formatted_sub_total=n,onInput:n=>N(n,u),class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-white px-4 py-2"},null,40,bt),[[p,s.formatted_sub_total]])])])])]))),128))]),e("div",vt,[e("div",null,[t[14]||(t[14]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Ummumiy summa",-1)),m(e("input",{type:"text","onUpdate:modelValue":t[2]||(t[2]=s=>a.value.formatted_k_amount=s),readonly:"",class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-600 text-gray-900 dark:text-white px-4 py-2"},null,512),[[p,a.value.formatted_k_amount]])]),e("div",null,[t[15]||(t[15]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Qo'shimcha ma'lumot",-1)),m(e("textarea",{"onUpdate:modelValue":t[3]||(t[3]=s=>a.value.description=s),rows:"3",class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-white px-4 py-2"},null,512),[[p,a.value.description]])])]),e("div",ft,[e("button",{type:"submit",class:"px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors",disabled:_.value},U(_.value?"Saqlanmoqda...":"Saqlash"),9,kt)])],32)])])}}};export{St as default};
