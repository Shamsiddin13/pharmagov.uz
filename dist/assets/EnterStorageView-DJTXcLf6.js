import{g as u,h as U,q as R,c as x,a as t,d as p,w as z,z as J,i as c,j as L,F as Q,b as Z,t as b,v as y,B as M,H,o as w,k as O,m as X}from"./index-D3wbM7oO.js";import{u as G}from"./useStorageFilterData-CC75njG6.js";import{A as D,e as W}from"./storageOperations-BR2fpJKr.js";import{_ as S}from"./SearchSelect-tzwJ1XQW.js";import{u as B,f as i}from"./numberFormat-CYHKIeaX.js";import"./auth-Buz3Qiex.js";const Y={class:"space-y-6"},ee={class:"bg-white dark:bg-gray-800 shadow rounded-lg p-6"},te={class:"flex justify-between items-center"},ae={class:"bg-white dark:bg-gray-800 shadow rounded-lg p-6"},re={class:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4"},oe={class:"space-y-4"},se={class:"flex justify-between"},le={class:"text-sm font-medium text-gray-700 dark:text-gray-300"},de=["onClick"],ne={class:"space-y-4"},ie={class:"flex gap-4"},ue={class:"flex-grow"},ce={class:"w-48"},ge=["onUpdate:modelValue"],be={class:"flex gap-4"},ye={class:"flex-1"},me={class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},pe=["onUpdate:modelValue","onInput","disabled"],_e={class:"flex-1"},ve=["onUpdate:modelValue","onInput","disabled"],ke={class:"flex-1"},fe={class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},he=["onUpdate:modelValue","onInput","disabled"],xe={class:"space-y-4 pt-6 border-t border-gray-200 dark:border-gray-700"},we={class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},Se=["value"],Ve={class:"flex justify-end space-x-4"},Ie=["disabled"],Ce={__name:"EnterStorageView",setup(qe){const P=X();G();const m=u(!1),r=u({store_id:"",kontragent_id:"",k_amount:0,formatted_k_amount:"0",k_debt_currency:"",type:"in",description:"",items:[]}),V=u(null),g=u(null),_=u([]),I={1:{id:1},5:{id:5},17:{id:35},18:{id:34},24:{id:110}},v=()=>{r.value.items.push({product_id:"",base_product_id:"",product_name:"",sku:"",article:"",real_buy_price:0,quantity:1,sub_total:0,formatted_sub_total:"0"})},$=a=>{r.value.items.splice(a,1),r.value.items.length===0&&v(),f()},C=async a=>{if(a){if(V.value=a,r.value.store_id=a.id,r.value.kontragent_id=null,g.value=null,I[a.id]){try{const e=localStorage.getItem("token"),s=await M.get(`${D}/search/kontragents`,{params:{id:I[a.id].id},headers:{Authorization:`Bearer ${e}`}});if(s.data&&s.data[0]){const d=s.data[0];r.value.kontragent_id=d.id,g.value=d}}catch(e){console.error("Error fetching mapped kontragent:",e)}return}if(a.group_id===48)try{const e=localStorage.getItem("token"),s=await M.get(`${D}/search/kontragents`,{params:{store_id:a.id,limit:1},headers:{Authorization:`Bearer ${e}`}});if(s.data&&s.data[0]){const d=s.data[0];r.value.kontragent_id=d.id,g.value=d}}catch(e){console.error("Error fetching kontragent:",e)}}},F=a=>{g.value=a,r.value.kontragent_id=a.id},j=(a,e)=>{const s=r.value.items[e],d=B(a.target.value);s.real_buy_price=d,s.formatted_buy_price=i(d),k(e)},A=a=>{k(a)},K=(a,e)=>{const s=r.value.items[e],d=B(a.target.value);s.sub_total=d,s.formatted_sub_total=i(d),s.sub_total&&s.quantity&&(s.real_buy_price=Math.round(s.sub_total/parseInt(s.quantity)),s.formatted_buy_price=i(s.real_buy_price)),f()},k=a=>{const e=r.value.items[a];e.real_buy_price&&e.quantity&&(e.sub_total=Math.round(e.real_buy_price*parseInt(e.quantity)),e.formatted_sub_total=i(e.sub_total),f())},f=()=>{r.value.k_amount=r.value.items.reduce((a,e)=>a+(e.sub_total?parseInt(e.sub_total):0),0)};U(()=>r.value.k_amount,a=>{r.value.formatted_k_amount=i(a)});const q=u(r.value.formatted_k_amount);U(()=>r.value.k_amount,a=>{q.value=i(a)});const N=(a,e)=>{const s=a.id,d=a.type==="variant"?a.base_product_id:a.id;if(r.value.items.some((n,l)=>l!==e&&n.product_id===s)){alert("Bu mahsulot qo'shilgan"),r.value.items[e].product_id="",r.value.items[e].product_name="",r.value.items[e].sku="",_.value[e]&&_.value[e].reset();return}const o=r.value.items[e];o.product_id=s,o.base_product_id=d,o.product_name=a.name,o.sku=a.sku,o.real_buy_price=Math.round(a.buy_price),o.formatted_buy_price=i(o.real_buy_price),o.article=a.article,k(e)},T=()=>{if(!r.value.store_id)return alert("Please select a store"),!1;if(!r.value.kontragent_id)return alert("Please select a kontragent"),!1;if(!r.value.k_debt_currency)return alert("Please select a currency"),!1;if(!r.value.items.length)return alert("Please add at least one item"),!1;for(const a of r.value.items)if(!a.product_id||!a.real_buy_price||!a.quantity)return alert("Please fill all required fields for each item"),!1;return!0},E=async()=>{if(T())try{m.value=!0;const a={...r.value,items:r.value.items.map(e=>({product_id:parseInt(e.base_product_id||e.product_id),sku:e.sku||"",article:e.article||"",real_buy_price:parseInt(e.real_buy_price),quantity:parseInt(e.quantity),sub_total:parseInt(e.sub_total)}))};await W(a),P.push("/storage")}catch(a){console.error("Failed to save enter storage:",a),alert(a.message||"Failed to save")}finally{m.value=!1}};return R(()=>{v()}),(a,e)=>{var d,h;const s=H("router-link");return w(),x("div",Y,[t("div",ee,[t("div",te,[e[6]||(e[6]=t("h1",{class:"text-2xl font-semibold text-gray-900 dark:text-white"},"Shunchaki kirim",-1)),p(s,{to:"/storage",class:"px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"},{default:z(()=>e[5]||(e[5]=[O(" Omborga qaytish ")])),_:1})])]),t("div",ae,[t("form",{onSubmit:J(E,["prevent"]),class:"space-y-6"},[t("div",re,[t("div",null,[e[7]||(e[7]=t("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Do'kon",-1)),p(S,{modelValue:r.value.store_id,"onUpdate:modelValue":e[0]||(e[0]=o=>r.value.store_id=o),"display-value":((d=V.value)==null?void 0:d.name)||"",placeholder:"Search store...","search-endpoint":"/search/stores",onSelect:C},null,8,["modelValue","display-value"])]),t("div",null,[e[8]||(e[8]=t("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Kontragent",-1)),p(S,{modelValue:r.value.kontragent_id,"onUpdate:modelValue":e[1]||(e[1]=o=>r.value.kontragent_id=o),"display-value":((h=g.value)==null?void 0:h.name)||"",placeholder:"Search kontragent...","search-endpoint":"/search/kontragents","additional-params":{store_id:r.value.store_id},onSelect:F,disabled:!r.value.store_id},null,8,["modelValue","display-value","additional-params","disabled"])]),t("div",null,[e[10]||(e[10]=t("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Valyuta",-1)),c(t("select",{"onUpdate:modelValue":e[2]||(e[2]=o=>r.value.k_debt_currency=o),class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-indigo-500"},e[9]||(e[9]=[t("option",{value:""},"Valyutani tanlash",-1),t("option",{value:"UZS"},"UZS",-1),t("option",{value:"USD"},"USD",-1)]),512),[[L,r.value.k_debt_currency]])])]),t("div",oe,[t("div",{class:"flex justify-between items-center"},[e[11]||(e[11]=t("h2",{class:"text-lg font-medium text-gray-900 dark:text-white"},"Mahsulotlar",-1)),t("button",{type:"button",onClick:v,class:"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"}," Mahsulot qo'shish ")]),(w(!0),x(Q,null,Z(r.value.items,(o,n)=>(w(),x("div",{key:n,class:"p-4 border border-gray-200 dark:border-gray-700 rounded-lg space-y-4"},[t("div",se,[t("h3",le,"Mahsulot "+b(n+1),1),t("button",{type:"button",onClick:l=>$(n),class:"text-red-600 hover:text-red-700"}," Mahsulotni o'chirish ",8,de)]),t("div",ne,[t("div",ie,[t("div",ue,[e[12]||(e[12]=t("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Mahsulot",-1)),p(S,{ref_for:!0,ref_key:"searchRefs",ref:_,"model-value":o.product_name,"display-value":o.product_name,"search-endpoint":"/search/products","additional-params":{store_id:r.value.store_id},placeholder:"Mahsulotni tanlash",disabled:!r.value.store_id,onSelect:l=>N(l,n)},null,8,["model-value","display-value","additional-params","disabled","onSelect"])]),t("div",ce,[e[13]||(e[13]=t("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"SKU",-1)),c(t("input",{type:"text","onUpdate:modelValue":l=>o.sku=l,readonly:"",class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-600 text-gray-900 dark:text-white px-4 py-2"},null,8,ge),[[y,o.sku]])])]),t("div",be,[t("div",ye,[t("label",me,"Xarid narxi ("+b(r.value.k_debt_currency||"-")+")",1),c(t("input",{type:"text","onUpdate:modelValue":l=>o.formatted_buy_price=l,onInput:l=>j(l,n),disabled:!o.product_id,class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-indigo-500 disabled:bg-gray-100 dark:disabled:bg-gray-800 disabled:cursor-not-allowed"},null,40,pe),[[y,o.formatted_buy_price]])]),t("div",_e,[e[14]||(e[14]=t("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Miqdori",-1)),c(t("input",{type:"number","onUpdate:modelValue":l=>o.quantity=l,onInput:l=>A(n),disabled:!o.product_id,required:"",min:"1",class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-indigo-500 disabled:bg-gray-100 dark:disabled:bg-gray-800 disabled:cursor-not-allowed"},null,40,ve),[[y,o.quantity]])]),t("div",ke,[t("label",fe,"Jami summa ("+b(r.value.k_debt_currency||"-")+")",1),c(t("input",{type:"text","onUpdate:modelValue":l=>o.formatted_sub_total=l,onInput:l=>K(l,n),disabled:!o.product_id,class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-indigo-500 disabled:bg-gray-100 dark:disabled:bg-gray-800 disabled:cursor-not-allowed"},null,40,he),[[y,o.formatted_sub_total]])])])])]))),128))]),t("div",xe,[t("div",null,[t("label",we,"Jami summa ("+b(r.value.k_debt_currency||"-")+")",1),t("input",{type:"text",value:q.value,readonly:"",class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-600 text-gray-900 dark:text-white px-4 py-2"},null,8,Se)]),t("div",null,[e[15]||(e[15]=t("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Qo'shimcha ma'lumot",-1)),c(t("textarea",{"onUpdate:modelValue":e[3]||(e[3]=o=>r.value.description=o),rows:"3",class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-indigo-500"},null,512),[[y,r.value.description]])])]),t("div",Ve,[t("button",{type:"button",onClick:e[4]||(e[4]=o=>a.$router.push("/storage")),class:"px-6 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"}," Bekor qilish "),t("button",{type:"submit",disabled:m.value,class:"px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50"},b(m.value?"Saqlash...":"Saqlash"),9,Ie)])],32)])])}}};export{Ce as default};
