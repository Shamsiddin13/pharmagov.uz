import{g as b,h as H,q as R,c as f,a as e,d as x,w as L,z as O,i as u,j as Z,F as J,b as X,t as h,v as c,n as M,I as C,H as G,o as w,k as W,f as Y,m as tt,B as et}from"./index-D3wbM7oO.js";import{_ as U}from"./SearchSelect-tzwJ1XQW.js";import{f as g,p as P}from"./numberFormat-CYHKIeaX.js";import{A as D}from"./api-JDA1JVME.js";import{g as at}from"./auth-Buz3Qiex.js";const rt={class:"space-y-6"},ot={class:"bg-white dark:bg-gray-800 shadow rounded-lg p-6"},lt={class:"flex justify-between items-center"},st={class:"bg-white dark:bg-gray-800 shadow rounded-lg p-6"},dt={class:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"},nt={class:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"},it={class:"space-y-4"},ut={class:"flex justify-between items-start"},ct={class:"text-md font-medium text-gray-900 dark:text-white"},gt=["onClick"],pt={class:"grid grid-cols-12 gap-4"},bt={class:"col-span-9"},yt={class:"col-span-3"},_t=["onUpdate:modelValue"],mt={class:"grid grid-cols-1 md:grid-cols-3 gap-4"},vt={class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},kt=["onUpdate:modelValue","onInput"],ft=["onUpdate:modelValue","onInput"],xt={class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},ht=["onUpdate:modelValue","onInput"],wt={class:"space-y-4 pt-6 border-t border-gray-200 dark:border-gray-700"},Vt={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},St={class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},It={class:"flex gap-4 items-end"},Ut={class:"flex-1"},qt={class:"flex gap-2"},jt={__name:"DebtOutStorageView",setup(Mt){const T=tt(),V=b(null),y=b(null),p=b([]),a=b({store_id:"",kontragent_id:"",k_amount:0,formatted_k_amount:"0",type:"out",k_debt_currency:"",items:[]}),S=()=>{a.value.items.push({product_id:"",variant_id:null,base_product_id:null,product_name:"",sku:"",article:"",real_buy_price:0,original_buy_price:0,formatted_buy_price:"0",quantity:1,sub_total:0,formatted_sub_total:"0"}),C(()=>{p.value.push(null)})},$=r=>{a.value.items.splice(r,1),p.value.splice(r,1),m()},j=async r=>{if(V.value=r,a.value.store_id=r.id,y.value=null,a.value.kontragent_id="",a.value.items=[],p.value=[],S(),r.group_id===48)try{const t=await fetch(`${D}/search/kontragents?store_id=${r.id}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`,"Content-Type":"application/json"}});if(!t.ok)throw new Error("Failed to fetch kontragent");const[o]=await t.json();o&&(y.value=o,a.value.kontragent_id=o.id)}catch(t){console.error("Error fetching kontragent:",t)}},N=r=>{y.value=r,a.value.kontragent_id=r.id},B=async(r,t)=>{const o=a.value.items[t],n=r.base_product_id||r.id,d=r.type==="variant"?r.id:null;if(a.value.items.some((l,i)=>i!==t&&l.product_id===n&&l.variant_id===d)){alert("Bu mahsulot qo'shilgan"),a.value.items[t]={...a.value.items[t],product_id:"",variant_id:null,base_product_id:null,product_name:"",sku:"",article:"",real_buy_price:0,original_buy_price:0,formatted_buy_price:"0",quantity:1,sub_total:0,formatted_sub_total:"0"},C(()=>{p.value[t]&&p.value[t].reset()});return}o.product_id=n,o.variant_id=d,o.base_product_id=r.base_product_id,o.product_name=r.name,o.sku=r.sku,o.article=r.article,o.real_buy_price=Math.round(r.buy_price||0),o.original_buy_price=Math.round(r.buy_price||0),o.formatted_buy_price=g(o.real_buy_price),o.quantity=1,_(t)},F=()=>{if(!v.value)return;const r=parseFloat(v.value)/100;a.value.items.forEach((t,o)=>{let n=t.original_buy_price,d=n*r;k.value==="minus"?t.real_buy_price=n-d:t.real_buy_price=n+d,t.formatted_buy_price=g(t.real_buy_price),_(o)}),m()},A=(r,t)=>{const o=P(r.target.value);a.value.items[t].real_buy_price=o,a.value.items[t].original_buy_price=o,a.value.items[t].formatted_buy_price=g(o),_(t)},z=r=>{_(r)},E=(r,t)=>{const o=a.value.items[t],n=P(r.target.value);o.sub_total=n,o.formatted_sub_total=g(n),o.sub_total&&o.quantity&&(o.real_buy_price=Math.round(o.sub_total/parseInt(o.quantity)),o.formatted_buy_price=g(o.real_buy_price)),m()},_=r=>{const t=a.value.items[r];t.real_buy_price&&t.quantity&&(t.sub_total=Math.round(t.real_buy_price*parseInt(t.quantity)),t.formatted_sub_total=g(t.sub_total),m())},m=()=>{a.value.k_amount=a.value.items.reduce((r,t)=>r+(t.sub_total?parseInt(t.sub_total):0),0)};H(()=>a.value.k_amount,r=>{a.value.formatted_k_amount=g(r)});const v=b(0),k=b("plus"),q=r=>{k.value=r},K=()=>{if(!a.value.store_id)return alert("Please select a store"),!1;if(!a.value.kontragent_id)return alert("Please select a kontragent"),!1;if(a.value.items.length===0)return alert("Please add at least one item"),!1;for(const r of a.value.items){if(!r.product_id)return alert("Please select a product for all items"),!1;if(!r.quantity||r.quantity<1)return alert("Please enter a valid quantity for all items"),!1}return!0},Q=async()=>{var r,t;if(K())try{const o=await at();(await et.post(`${D}/storages/debt/out`,{store_id:parseInt(a.value.store_id),kontragent_id:parseInt(a.value.kontragent_id),k_debt_currency:a.value.k_debt_currency,k_amount:a.value.k_amount,description:a.value.description,items:a.value.items.map(d=>({product_id:parseInt(d.product_id),variant_id:d.variant_id,sku:d.sku,article:d.article,real_buy_price:d.real_buy_price,quantity:d.quantity,sub_total:d.sub_total}))},{headers:o})).data.status&&T.push("/storage")}catch(o){console.error("Error submitting form:",o),alert(((t=(r=o.response)==null?void 0:r.data)==null?void 0:t.message)||"An error occurred")}};return R(()=>{S()}),(r,t)=>{var n,d,I;const o=G("router-link");return w(),f("div",rt,[e("div",ot,[e("div",lt,[t[9]||(t[9]=e("h1",{class:"text-2xl font-semibold text-gray-900 dark:text-white"},"Qarz Qaytarish",-1)),x(o,{to:"/storage",class:"px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"},{default:L(()=>t[8]||(t[8]=[W(" Omborga qaytish ")])),_:1})])]),e("div",st,[e("form",{onSubmit:O(Q,["prevent"]),class:"space-y-6"},[e("div",dt,[e("div",null,[t[10]||(t[10]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Do'kon",-1)),x(U,{modelValue:a.value.store_id,"onUpdate:modelValue":t[0]||(t[0]=l=>a.value.store_id=l),"display-value":((n=V.value)==null?void 0:n.name)||"",placeholder:"Search store...","search-endpoint":"/search/stores","additional-params":{group_id:47},onSelect:j},null,8,["modelValue","display-value"])]),e("div",null,[t[11]||(t[11]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Kontragent",-1)),x(U,{modelValue:a.value.kontragent_id,"onUpdate:modelValue":t[1]||(t[1]=l=>a.value.kontragent_id=l),"display-value":((d=y.value)==null?void 0:d.name)||"",placeholder:"Search kontragent...","search-endpoint":"/search/kontragents","additional-params":{store_id:a.value.store_id},onSelect:N,disabled:((I=V.value)==null?void 0:I.group_id)===48},null,8,["modelValue","display-value","additional-params","disabled"])])]),e("div",nt,[e("div",null,[t[13]||(t[13]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Valyuta",-1)),u(e("select",{"onUpdate:modelValue":t[2]||(t[2]=l=>a.value.k_debt_currency=l),class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-indigo-500"},t[12]||(t[12]=[e("option",{value:""},"Valyuta tanlang",-1),e("option",{value:"UZS"},"UZS",-1),e("option",{value:"USD"},"USD",-1)]),512),[[Z,a.value.k_debt_currency]])])]),e("div",it,[e("div",{class:"flex justify-between items-center"},[t[14]||(t[14]=e("h2",{class:"text-lg font-medium text-gray-900 dark:text-white"},"Mahsulotlar",-1)),e("button",{type:"button",onClick:S,class:"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"}," Mahsulot qo'shish ")]),(w(!0),f(J,null,X(a.value.items,(l,i)=>(w(),f("div",{key:i,class:"p-4 border border-gray-200 dark:border-gray-700 rounded-lg space-y-4"},[e("div",ut,[e("h3",ct,"Mahsulot "+h(i+1),1),a.value.items.length>1?(w(),f("button",{key:0,type:"button",onClick:s=>$(i),class:"text-red-600 hover:text-red-700"}," Mahsulotni o'chirish ",8,gt)):Y("",!0)]),e("div",pt,[e("div",bt,[t[15]||(t[15]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Mahsulot",-1)),x(U,{ref_for:!0,ref:s=>{s&&(p.value[i]=s)},"model-value":l.product_id,"display-value":l.product_name,"search-endpoint":"/search/products","additional-params":{store_id:a.value.store_id},placeholder:"Select product",disabled:!a.value.store_id,onSelect:s=>B(s,i)},null,8,["model-value","display-value","additional-params","disabled","onSelect"])]),e("div",yt,[t[16]||(t[16]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"SKU",-1)),u(e("input",{type:"text","onUpdate:modelValue":s=>l.sku=s,class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2",readonly:""},null,8,_t),[[c,l.sku]])])]),e("div",mt,[e("div",null,[e("label",vt,"Xarid Narxi ("+h(a.value.k_debt_currency)+")",1),u(e("input",{type:"text","onUpdate:modelValue":s=>l.formatted_buy_price=s,onInput:s=>A(s,i),class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2"},null,40,kt),[[c,l.formatted_buy_price]])]),e("div",null,[t[17]||(t[17]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Miqdori",-1)),u(e("input",{type:"number","onUpdate:modelValue":s=>l.quantity=s,min:"1",onInput:s=>z(i),class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2"},null,40,ft),[[c,l.quantity]])]),e("div",null,[e("label",xt,"Jami Narxi ("+h(a.value.k_debt_currency)+")",1),u(e("input",{type:"text","onUpdate:modelValue":s=>l.formatted_sub_total=s,onInput:s=>E(s,i),class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2"},null,40,ht),[[c,l.formatted_sub_total]])])])]))),128))]),e("div",wt,[e("div",Vt,[e("div",null,[e("label",St,"Umumiy summa ("+h(a.value.k_debt_currency)+")",1),u(e("input",{type:"text","onUpdate:modelValue":t[3]||(t[3]=l=>a.value.formatted_k_amount=l),readonly:"",class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-600 text-gray-900 dark:text-white px-4 py-2"},null,512),[[c,a.value.formatted_k_amount]])]),e("div",It,[e("div",Ut,[t[18]||(t[18]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Foiz",-1)),u(e("input",{type:"number","onUpdate:modelValue":t[4]||(t[4]=l=>v.value=l),step:"0.1",class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2",placeholder:"0.5"},null,512),[[c,v.value]])]),e("div",qt,[e("button",{type:"button",class:M(["px-4 py-2 rounded-lg transition-colors",k.value==="plus"?"bg-indigo-600 text-white":"bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200"]),onClick:t[5]||(t[5]=l=>q("plus"))}," + ",2),e("button",{type:"button",class:M(["px-4 py-2 rounded-lg transition-colors",k.value==="minus"?"bg-indigo-600 text-white":"bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200"]),onClick:t[6]||(t[6]=l=>q("minus"))}," - ",2)]),e("button",{type:"button",class:"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors",onClick:F}," Hisoblash ")])])]),e("div",null,[t[19]||(t[19]=e("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Qo'shimcha ma'lumot",-1)),u(e("textarea",{"onUpdate:modelValue":t[7]||(t[7]=l=>a.value.description=l),rows:"3",class:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2 focus:ring-2 focus:ring-indigo-500"},null,512),[[c,a.value.description]])]),t[20]||(t[20]=e("div",{class:"flex justify-end"},[e("button",{type:"submit",class:"px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"}," Saqlash ")],-1))],32)])])}}};export{jt as default};
